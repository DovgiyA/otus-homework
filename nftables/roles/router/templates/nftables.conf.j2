#!/usr/sbin/nft -f

flush ruleset

table ip filter {
    set knock_whitelist {
        type ipv4_addr
    }

    chain input {
        type filter hook input priority 0; policy accept;
        
        # Accept established and related
        ct state established,related accept
        iif "lo" accept

        # Allow SSH for whitelisted IPs
        ip saddr @knock_whitelist tcp dport 22 accept

        # Block SSH from centralRouter (192.168.50.11) unless whitelisted
        ip saddr 192.168.50.11 tcp dport 22 drop
    }
    
    chain forward {
        type filter hook forward priority 0; policy accept;
    }
    
    chain output {
        type filter hook output priority 0; policy accept;
    }
}

table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        oif "eth0" masquerade
    }
}
